document.addEventListener("DOMContentLoaded",()=>{const t=document.body,e=document.getElementById("menu-toggle-btn"),n=document.getElementById("sidebar-overlay"),o=document.getElementById("new-chat-btn"),i=document.getElementById("chat-container"),s=document.getElementById("welcome-screen"),a=document.getElementById("chat-input"),r=document.getElementById("generate-btn"),c=document.getElementById("history-container"),l=document.getElementById("voice-btn"),d=document.getElementById("more-options-btn"),u=document.getElementById("file-popup-menu"),m=document.getElementById("attach-file-btn"),p=document.getElementById("attach-camera-btn"),h=document.getElementById("file-input"),f=document.getElementById("attachment-preview"),g=document.getElementById("voice-recorder-ui"),v=document.getElementById("recorder-timer"),y=document.getElementById("waveform-visualizer"),b=document.querySelector(".recorder-actions"),w=document.querySelector(".recorder-status"),k=document.getElementById("delete-voice-btn"),E=document.getElementById("send-voice-btn"),x=document.getElementById("input-wrapper"),L=document.getElementById("model-selector-btn"),C=document.getElementById("model-modal"),S=document.querySelectorAll(".model-option"),A=document.getElementById("model-display-name"),I=document.getElementById("notification-toast"),B=document.getElementById("agent-mode-btn"),q=document.getElementById("task-progress-container"),T=document.getElementById("task-list"),M=document.getElementById("progress-header"),P=document.getElementById("preview-modal"),N=document.getElementById("close-preview-btn"),_=document.getElementById("preview-iframe");let H={},D=null,O="gemini-1.5-flash-latest",j=null,V=false,F=false,z=false,R,W,G,J;const K=window.SpeechRecognition||window.webkitSpeechRecognition;K?(R=new K,R.continuous=true,R.interimResults=true,R.lang="id-ID",R.onresult=(t=>{let e="",n="";for(let o=t.resultIndex;o<t.results.length;++o)t.results[o].isFinal?n+=t.results[o][0].transcript:e+=t.results[o][0].transcript;a.value=n+e,a.style.height="auto",a.style.height=`${a.scrollHeight}px`}),R.onend=(()=>{z=false,clearInterval(W),w.style.display="none",b.style.display="flex"}),R.onerror=(t=>{console.error("Speech Recognition Error:",t.error),z=false,clearInterval(W),g.style.display="none",x.style.display="flex"})):l&&(l.disabled=true);const U=(t)=>{const e=Math.floor(t/60),n=t%60;return`${e.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},Q=()=>{y.innerHTML="";for(let t=0;t<20;t++){const e=document.createElement("div");e.className="waveform-bar",e.style.animationDelay=`${.5*Math.random()}s`,e.style.animationDuration=`${.8+.7*Math.random()}s`,y.appendChild(e)}},Z=(t)=>{I.textContent=t,I.classList.add("show"),setTimeout(()=>{I.classList.remove("show")},3e3)},$=()=>{i&&(i.scrollTop=i.scrollHeight)};e.addEventListener("click",()=>t.classList.toggle("sidebar-open")),n.addEventListener("click",()=>t.classList.remove("sidebar-open")),d.addEventListener("click",(t=>{t.stopPropagation(),u.classList.toggle("active")})),window.addEventListener("click",()=>{u.classList.remove("active"),C.classList.remove("active")}),m.addEventListener("click",()=>{h.removeAttribute("capture"),h.setAttribute("accept","*/*"),h.click()}),p.addEventListener("click",()=>{h.setAttribute("capture","environment"),h.setAttribute("accept","image/*"),h.click()}),l.addEventListener("click",()=>{R&&(z?R.stop():(z=true,a.value="",R.start(),g.style.display="flex",x.style.display="none",w.style.display="flex",b.style.display="none",Q(),(()=>{let t=0;v.textContent="00:00",W=setInterval(()=>{t++,v.textContent=U(t)},1e3)})()))}),k.addEventListener("click",()=>{a.value="",g.style.display="none",x.style.display="flex"}),E.addEventListener("click",()=>{g.style.display="none",x.style.display="flex",tt()}),L.addEventListener("click",(t=>{t.stopPropagation(),C.classList.add("active")})),S.forEach((t=>{t.addEventListener("click",()=>{O=t.dataset.model,A.textContent=t.dataset.displayName,S.forEach((t=>t.classList.remove("selected"))),t.classList.add("selected"),C.classList.remove("active"),Z(`${t.dataset.displayName.toUpperCase()} READY`)})})),h.addEventListener("change",(t=>{const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onloadend=(()=>{const t=n.result,o=t.split(",")[1];j={mimeType:e.type,base64:o},ot(e.name,t)}),n.readAsDataURL(e),u.classList.remove("active")})),a.addEventListener("input",()=>{a.style.height="auto",a.style.height=`${a.scrollHeight}px`}),N.addEventListener("click",()=>P.classList.remove("active")),P.addEventListener("click",(t=>{t.target===P&&P.classList.remove("active")})),B.addEventListener("click",()=>{V=!V,B.classList.toggle("active"),Z(V?"Mode Proyek Diaktifkan":"Mode Proyek Dinonaktifkan"),F&&(F=false,r.disabled=false,q.classList.remove("project-active"),q.style.display="none")}),M.addEventListener("click",()=>q.classList.toggle("collapsed")),r.onclick=tt,a.addEventListener("keydown",(t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),tt())}));async function tt(){const t=a.value.trim();if(!t&&!j||F)return;nt(t),a.value="",a.style.height="auto",it(),r.disabled=true;try{V?await et(t):await(async function(){const t=st();G=new AbortController,r.classList.add("generating"),r.onclick=()=>{G.abort()};try{const e=await at(H[D],"chat");t.element.remove(),rt(e.data)}catch(e){"AbortError"===e.name?rt("Respon dihentikan."):(console.error("Error fetching AI response:",e),rt("Maaf, terjadi kesalahan. ü§ñ"))}finally{cancelAnimationFrame(J),r.classList.remove("generating"),r.onclick=tt}})()}catch(t){console.error("Error during generation:",t);const e=document.getElementById("typing-indicator");e&&e.remove(),cancelAnimationFrame(J),rt("Maaf, terjadi kesalahan di pihak saya. Coba lagi nanti ya. üôè")}finally{r.disabled=false}}async function et(t){F=true,q.classList.add("project-active");const e=st();try{const n=(await at([{role:"user",parts:[{text:t}]}],"manus_planner")).data.project_plan;e.element.remove(),cancelAnimationFrame(J),lt(n),rt(`Booting **Alfhaiz Computer**... Rencana proyek untuk "${t}" telah dibuat. Memulai eksekusi...`);for(let t=0;t<n.length;t++)await dt(t,n[t])}catch(t){throw e.element.remove(),cancelAnimationFrame(J),rt("Maaf, saya gagal membuat rencana proyek. Coba berikan perintah yang lebih jelas."),t}finally{F=false,q.classList.remove("project-active")}}async function nt(t){s&&(s.style.display="none"),D||(D=`chat_${Date.now()}`,H[D]=[],ht(D,t||"Chat with attachment"));const e=[];let n=j?`data:${j.mimeType};base64,${j.base64}`:null;j&&e.push({inlineData:{mimeType:j.mimeType,data:j.base64}}),t&&e.push({text:t}),ct(t,n),H[D].push({role:"user",parts:e})}function ot(t,e){f.innerHTML=`<div class="preview-item">${e.startsWith("data:image")?`<img src="${e}" alt="Preview">`:""}<span>${t}</span><button class="remove-attachment-btn" id="remove-attachment-btn">&times;</button></div>`,document.getElementById("remove-attachment-btn").addEventListener("click",it)}function it(){j=null,h.value="",f.innerHTML=""}o.addEventListener("click",(t=>{t.preventDefault(),D=null,ft(),t.classList.contains("sidebar-open")&&t.classList.remove("sidebar-open"),gt(null)})),r.onclick=tt,a.addEventListener("keydown",(t=>{"Enter"===t.key&&!t.shiftKey&&(t.preventDefault(),tt())}));async function st(){const t=document.createElement("div");t.className="message ai loading-indicator",t.id="typing-indicator";const e=["Booting system...","Alfhaiz Computer is working...","Compiling code..."];t.innerHTML=`<div class="loading-indicator-main"><div class="gemini-loader"></div><span class="loading-text">${e[0]}</span></div><span class="loading-timer">0.000s</span>`,i.appendChild(t),$();const n=t.querySelector(".loading-text"),o=t.querySelector(".loading-timer");let s=1;const a=setInterval((()=>{n&&(n.textContent=e[s%e.length]),s++}),2500);let r=performance.now();return function t(){const e=(performance.now()-r)/1e3;o.textContent=`${e.toFixed(3)}s`,J=requestAnimationFrame(t)}(),{element:t,intervalId:a}}async function at(t,e){const n=await fetch("/api/generate",{method:"POST",headers:{"Content-Type":"application/json"},signal:G?G.signal:null,body:JSON.stringify({history:t,model:O,mode:e})});if(!n.ok){const t=await n.json();throw new Error(t.error||`HTTP error! status: ${n.status}`)}return await n.json()}async function rt(t){const e=ct("model",t);D&&H[D]&&H[D].push({role:"model",parts:[{text:t}]});return e}function ct(t,e,n=null){const o=document.createElement("div");o.className=`message ${"user"===t?"user":"ai"}`,n&&(()=>{const t=document.createElement("img");t.src=n,t.alt="Lampiran",o.appendChild(t)})(),e&&(()=>{const n=document.createElement("div");n.innerHTML="user"!==t&&window.marked?marked.parse(e):e,o.appendChild(n)})(),i.appendChild(o),$();return o}async function dt(t,e){const n=document.getElementById(`task-${t}`);n.classList.add("in-progress");const o=st(),s=`Kerjakan tugas ini: "${e.title}". Deskripsi: "${e.description}"`,a=(await at([{role:"user",parts:[{text:s}]}],"manus_executor")).data;o.element.remove(),cancelAnimationFrame(J),n.classList.remove("in-progress"),n.classList.add("completed"),n.querySelector(".task-item-description").textContent=a.summary;const r=rt(a.chat_message);a.final_project_files&&ut(a.final_project_files,r)}function ut(t,e){const n=t["index.html"]||"",o=t["style.css"]||"",i=t["app.js"]||"";_.srcdoc=`<!DOCTYPE html><html><head><style>${o}</style></head><body>${n}<script>${i}<\/script></body></html>`,P.classList.add("active");const s=document.createElement("div");s.className="file-downloads";for(const n in t)s.appendChild(mt(n,t[n]));e.appendChild(s)}function mt(t,e){const n=document.createElement("a"),o=new Blob([e],{type:"text/plain;charset=utf-8"});return n.href=URL.createObjectURL(o),n.download=t,n.className="download-link",n.innerHTML=`<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M5 20h14v-2H5v2zm14-9h-4V3H9v8H5l7 7 7-7z"></path></svg>${t}`,n}function pt(t){T.innerHTML="",t.forEach(((t,e)=>{const n=document.createElement("li");n.id=`task-${e}`,n.className="task-item",n.innerHTML=`<div class="task-item-title"><div class="task-status-icon"></div><span>${t.title}</span></div><p class="task-item-description">${t.description}</p>`,T.appendChild(n)})),q.style.display="block",q.classList.remove("collapsed")}function ht(t,e){const n=document.createElement("a");n.href="#",n.className="nav-item",n.dataset.chatId=t,n.innerHTML=`<svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M21 11.01L3 11v2h18zM3 16h12v2H3zM21 6H3v2.01L21 8z"></path></svg><span>${e.substring(0,20)+(e.length>20?"...":"")}</span>`,n.addEventListener("click",(e=>{e.preventDefault(),vt(t)})),c.prepend(n),gt(t)}function ft(){i.querySelectorAll(".message, .loading-indicator").forEach((t=>t.remove())),s.style.display="block",it(),q.style.display="none",document.querySelectorAll("#history-container .nav-item").forEach((t=>t.classList.remove("active")))}function gt(t){document.querySelectorAll("#history-container .nav-item").forEach((e=>{e.dataset.chatId===t?e.classList.add("active"):e.classList.remove("active")})),t?o.classList.remove("active"):o.classList.add("active")}function vt(t){if(!H[t])return;D=t,ft(),s.style.display="none",H[t].forEach((t=>{const e=t.parts.find((t=>t.text))?.text||"",n=t.parts.find((t=>t.inlineData)),o=n?`data:${n.inlineData.mimeType};base64,${n.inlineData.data}`:null;ct(t.role,e,o)})),gt(t)}});
