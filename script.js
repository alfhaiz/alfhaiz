document.addEventListener("DOMContentLoaded",()=>{const t=document.body,e=document.getElementById("menu-toggle-btn"),n=document.getElementById("sidebar-overlay"),o=document.getElementById("new-chat-btn"),i=document.getElementById("chat-container"),s=document.getElementById("welcome-screen"),a=document.getElementById("chat-input"),r=document.getElementById("generate-btn"),c=document.getElementById("history-container"),l=document.getElementById("voice-btn"),d=document.getElementById("more-options-btn"),u=document.getElementById("file-popup-menu"),m=document.getElementById("attach-file-btn"),p=document.getElementById("attach-camera-btn"),h=document.getElementById("file-input"),f=document.getElementById("attachment-preview"),g=document.getElementById("voice-recorder-ui"),v=document.getElementById("recorder-timer"),y=document.getElementById("waveform-visualizer"),b=document.querySelector(".recorder-actions"),w=document.querySelector(".recorder-status"),k=document.getElementById("delete-voice-btn"),E=document.getElementById("send-voice-btn"),x=document.getElementById("input-wrapper"),L=document.getElementById("model-selector-btn"),C=document.getElementById("model-modal"),S=document.querySelectorAll(".model-option"),A=document.getElementById("model-display-name"),I=document.getElementById("notification-toast"),B=document.getElementById("agent-mode-btn"),q=document.getElementById("live-preview-container"),T=document.getElementById("live-preview-iframe"),M=document.getElementById("agent-log-console");let P={},N=null,O="gemini-1.5-pro-latest",j=null,V=!1,F,z,R,W;const G=window.SpeechRecognition||window.webkitSpeechRecognition;G?(F=new G,F.continuous=!0,F.interimResults=!0,F.lang="id-ID",F.onresult=(t=>{let e="",n="";for(let o=t.resultIndex;o<t.results.length;++o)t.results[o].isFinal?n+=t.results[o][0].transcript:e+=t.results[o][0].transcript;a.value=n+e,a.style.height="auto",a.style.height=`${a.scrollHeight}px`}),F.onend=()=>{z=!1,clearInterval(R),w.style.display="none",b.style.display="flex"},F.onerror=t=>{console.error("Speech Recognition Error:",t.error),z=!1,clearInterval(R),g.style.display="none",x.style.display="flex"}):l&&(l.disabled=!0);const J=t=>{const e=Math.floor(t/60),n=t%60;return`${e.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},K=()=>{y.innerHTML="";for(let t=0;t<20;t++){const e=document.createElement("div");e.className="waveform-bar",e.style.animationDelay=`${.5*Math.random()}s`,e.style.animationDuration=`${.8+.7*Math.random()}s`,y.appendChild(e)}},U=t=>{I.textContent=t,I.classList.add("show"),setTimeout(()=>{I.classList.remove("show")},3e3)},Q=()=>{i&&i.scrollTop=i.scrollHeight};e.addEventListener("click",()=>t.classList.toggle("sidebar-open")),n.addEventListener("click",()=>t.classList.remove("sidebar-open")),d.addEventListener("click",(t=>{t.stopPropagation(),u.classList.toggle("active")})),window.addEventListener("click",()=>{u.classList.remove("active"),C.classList.remove("active")}),m.addEventListener("click",()=>{h.removeAttribute("capture"),h.setAttribute("accept","*/*"),h.click()}),p.addEventListener("click",()=>{h.setAttribute("capture","environment"),h.setAttribute("accept","image/*"),h.click()}),l.addEventListener("click",()=>{if(!F)return;z?F.stop():(z=!0,a.value="",F.start(),g.style.display="flex",x.style.display="none",w.style.display="flex",b.style.display="none",K(),(()=>{let t=0;v.textContent="00:00",R=setInterval(()=>{t++,v.textContent=J(t)},1e3)})())}),k.addEventListener("click",()=>{a.value="",g.style.display="none",x.style.display="flex"}),E.addEventListener("click",()=>{g.style.display="none",x.style.display="flex",$()}),S.forEach((t=>{t.addEventListener("click",()=>{O=t.dataset.model,A.textContent=t.dataset.displayName,S.forEach((t=>t.classList.remove("selected"))),t.classList.add("selected"),C.classList.remove("active"),U(`${t.dataset.displayName.toUpperCase()} READY`)})})),h.addEventListener("change",(t=>{const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onloadend=()=>{const t=n.result,o=t.split(",")[1];j={mimeType:e.type,base64:o},tt(e.name,t)},n.readAsDataURL(e),u.classList.remove("active")})),a.addEventListener("input",()=>{a.style.height="auto",a.style.height=`${a.scrollHeight}px`}),B.addEventListener("click",()=>{V=!V,B.classList.toggle("active"),V?(a.placeholder="Perintahkan saya untuk membuat sesuatu...",i.style.display="none",s.style.display="none",q.style.display="flex",M.innerHTML="",T.style.opacity="0"):(a.placeholder="Ask me anything...",i.style.display="flex",i.querySelector(".message")||(s.style.display="block"),q.style.display="none")}),r.onclick=$,a.addEventListener("keydown",(t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),$())}));async function $(){const t=a.value.trim();if(!t&&!j)return;if(V)await(async function(t){r.disabled=!0,M.innerHTML="",T.style.opacity="0";const e=["<span class='tag'>[ Menganalisis ]</span> Menganalisis permintaan Anda...","<span class='tag'>[ Merancang ]</span> Merancang struktur dasar HTML...","<span class='tag'>[ Menulis Kode ]</span> Menulis CSS & JavaScript...","<span class='tag'>[ Finalisasi ]</span> Merender kode dan menyelesaikan..."],n=async()=>{M.style.display="flex";for(let t=0;t<e.length;t++){await new Promise((e=>setTimeout(e,800+500*Math.random())));const n=document.createElement("div");n.className="log-line",n.innerHTML=e[t],M.appendChild(n),M.scrollTop=M.scrollHeight}};const o=it("agent",[{text:t}]);try{const[t,i]=await Promise.all([n(),o]);await new Promise((e=>setTimeout(e,500)));const s=document.createElement("div");s.className="log-line",s.innerHTML="<span class='tag'>[ Selesai ]</span> Proses building selesai!",M.appendChild(s),setTimeout(()=>{M.style.display="none",T.srcdoc=i.data,T.style.opacity="1"},1e3)}catch(t){console.error("Agent mode error:",t),M.innerHTML="<div class='log-line'><span class='tag'>[ ERROR ]</span> Gagal mem-build, coba lagi.</div>"}finally{r.disabled=!1}}(t));else{et(t);const e=a.value;a.value="",a.style.height="auto",nt();const n=rt();W=new AbortController,r.classList.add("generating"),r.onclick=()=>{W.abort()};try{const t=await it("chat",P[N]);n.element.remove(),st(t.data)}catch(t){n.element.remove(),"AbortError"===t.name?st("Respon dihentikan."):(console.error("Error fetching AI response:",t),st("Maaf, terjadi kesalahan. ðŸ¤–"))}finally{r.classList.remove("generating"),r.onclick=$}}a.value="",a.style.height="auto"}function tt(t,e){f.innerHTML=`<div class="preview-item">${e.startsWith("data:image")?`<img src="${e}" alt="Preview">`:""}<span>${t}</span><button class="remove-attachment-btn" id="remove-attachment-btn">&times;</button></div>`,document.getElementById("remove-attachment-btn").addEventListener("click",nt)}function et(t){s.style.display="none",N||(N=`chat_${Date.now()}`,P[N]=[],at(N,t||"Chat with attachment"));const e=[],n=j?`data:${j.mimeType};base64,${j.base64}`:null;j&&e.push({inlineData:{mimeType:j.mimeType,data:j.base64}}),t&&e.push({text:t}),lt(t,n),P[N].push({role:"user",parts:e})}function nt(){j=null,h.value="",f.innerHTML=""}o.addEventListener("click",(t=>{t.preventDefault(),N=null,dt(),t.classList.contains("sidebar-open")&&t.classList.remove("sidebar-open"),ut(null)})),r.onclick=$,a.addEventListener("keydown",(t=>{"Enter"===t.key&&!t.shiftKey&&(t.preventDefault(),$())}));async function it(t,e){const n=await fetch("/api/generate",{method:"POST",headers:{"Content-Type":"application/json"},signal:W?W.signal:null,body:JSON.stringify({history:e,model:O,mode:t})});if(!n.ok){const t=await n.json();throw new Error(t.error||`HTTP error! status: ${n.status}`)}return await n.json()}function st(t){ct("model",t),N&&P[N]&&P[N].push({role:"model",parts:[{text:t}]})}function at(t,e){const n=document.createElement("a");n.href="#",n.className="nav-item",n.dataset.chatId=t,n.innerHTML=`<svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M21 11.01L3 11v2h18zM3 16h12v2H3zM21 6H3v2.01L21 8z"></path></svg><span>${e.substring(0,20)+(e.length>20?"...":"")}</span>`,n.addEventListener("click",(e=>{e.preventDefault(),pt(t)})),c.prepend(n),ut(t)}function rt(){const t=document.createElement("div");t.className="loading-indicator";const e=["Tunggu sebentar...","Alfhaiz sedang berfikir...","Menyusun jawaban..."];const n=document.createElement("div");n.className="gemini-loader";const o=document.createElement("span");return o.className="loading-text",o.textContent=e[0],t.appendChild(n),t.appendChild(o),i.appendChild(t),Q(),(()=>{let t=1;const n=setInterval((()=>{o.textContent=e[t%e.length],t++}),2e3);return{element:t,intervalId:n}})()}function ct(t,e){const n=document.createElement("div");n.className=`message ${"user"===t?"user":"ai"}`,e&&("model"!==t&&window.marked?n.innerHTML=marked.parse(e.replace(/</g,"&lt;").replace(/>/g,"&gt;")):n.textContent=e),i.appendChild(n),Q()}function lt(t,e=null){const n=document.createElement("div");n.className="message user",e&&(()=>{const t=document.createElement("img");t.src=e,t.alt="Lampiran",n.appendChild(t)})(),t&&(()=>{const e=document.createElement("p");e.textContent=t,n.appendChild(e)})(),i.appendChild(n),Q()}function dt(){i.querySelectorAll(".message, .loading-indicator").forEach((t=>t.remove())),s.style.display="block",nt(),document.querySelectorAll("#history-container .nav-item").forEach((t=>t.classList.remove("active")))}function ut(t){document.querySelectorAll("#history-container .nav-item").forEach((e=>{e.dataset.chatId===t?e.classList.add("active"):e.classList.remove("active")})),t?o.classList.remove("active"):o.classList.add("active")}function mt(t){const e=P[t].find((t=>t.parts.find((t=>t.text))))?.parts.find((t=>t.text)).text||"";at(t,e)}function pt(t){if(!P[t])return;N=t,dt(),s.style.display="none";P[t].forEach((t=>{const e=t.parts.find((t=>t.text))?.text||"",n=t.parts.find((t=>t.inlineData)),o=n?`data:${n.inlineData.mimeType};base64,${n.inlineData.data}`:null;"user"===t.role?lt(e,o):st(e)})),ut(t)}});
